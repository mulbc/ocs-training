<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Deploying Red Hat AMQ Streams backed by OpenShift Container Storage :: OCS Training</title>
    <link rel="canonical" href="https://mulbc.github.io/ocs-training/bestPractice/ocs4kafka/Readme.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://mulbc.github.io/ocs-training">OCS Training</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="bestPractice" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OCS Best Practices</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Overview</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4jenkins/Jenkins.html">Jenkins with OCS4</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="Readme.html">Kafka with OCS4</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4logging/Readme.html">Openshift Logging with OCS4</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4metrics/Readme.html">Openshift Metrics with OCS4</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4postgresql/PostgreSQL.html">PostgreSQL with OCS4</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4registry/registry.html">Openshift registry with OCS4</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OCS Best Practices</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OCS Best Practices</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">OCS Installation and Configuration</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../install&configure/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../install&configure/siteindex.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OCS Best Practices</a></li>
    <li><a href="Readme.html">Kafka with OCS4</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/mulbc/ocs-training/edit/master/bestPractice/modules/ocs4kafka/pages/Readme.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Lab: Deploying Red Hat AMQ Streams backed by OpenShift Container Storage</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_lab_overview">1. Lab Overview</a>
<ul class="sectlevel2">
<li><a href="#_in_this_lab_you_will_learn">1.1. In this lab you will learn</a></li>
</ul>
</li>
<li><a href="#_introduction">2. Introduction</a></li>
<li><a href="#_installing_red_hat_amq_streams">3. Installing Red Hat AMQ Streams</a></li>
<li><a href="#_creating_zookeeper_and_kafka_clusters">4. Creating Zookeeper and Kafka Clusters</a></li>
<li><a href="#_create_kafka_topic_and_kafka_user">5. Create Kafka Topic and Kafka User</a></li>
<li><a href="#_create_a_sample_kafka_producer_and_consumer_application">6. Create a sample Kafka Producer and Consumer Application</a></li>
<li><a href="#_ocs_making_kafka_cluster_more_resilient">7. OCS : Making Kafka cluster more resilient</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_lab_overview"><a class="anchor" href="#_lab_overview"></a>1. Lab Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab, you will be deploying Red Hat AMQ Streams which is based on Apache Kafka, a popular platform for streaming data delivery and processing.</p>
</div>
<div class="sect2">
<h3 id="_in_this_lab_you_will_learn"><a class="anchor" href="#_in_this_lab_you_will_learn"></a>1.1. In this lab you will learn</h3>
<div class="ulist">
<ul>
<li>
<p>Kafka / RHT AMQ Streams introduction, architecture and storage use-case.</p>
</li>
<li>
<p>Installing Red Hat AMQ Streams Operator from OpenShift OperatorHub</p>
</li>
<li>
<p>Deploying Zookeeper and Kafka with persistent storage from OCS</p>
</li>
<li>
<p>Creating Kafka topic and Kafka user, using their respective operators</p>
</li>
<li>
<p>Creating a Kafka Producer and Consumer application</p>
</li>
<li>
<p>Testing Kafka High Availability Powered by OCS</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>2. Introduction</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-03.png" alt="Apache Kafka">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-04.png" alt="Apache Kafka Architecture">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-05.png" alt="Apache Kafka use cases">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-06.png" alt="Red Hat AMQ Streams">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-07.png" alt="Storage use cases for Apache Kafka">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installing_red_hat_amq_streams"><a class="anchor" href="#_installing_red_hat_amq_streams"></a>3. Installing Red Hat AMQ Streams</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Create a new project called <code>amq-streams</code> from openshift console by navigating to the projects as shown below</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-13.png" alt="Create amq-stream project">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also create the project from the command line as shown below
</td>
</tr>
</table>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc new-project amq-streams</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure to select the <code>amq-streams</code> project and search AMQ Streams Operator from the OperatorHub</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-08.png" alt="Red Hat AMQ Streams Operator Installation">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Install the AMQ Streams Operator</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-09.png" alt="Red Hat AMQ Streams Operator Installation">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Under Installation Mode, select <code>amq-stream</code> as the namespace</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Selecting a specific namespace to help us purge the operator and its resources easily
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-10.png" alt="Red Hat AMQ Streams Operator Installation">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Verify the installed operator</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-11.png" alt="Red Hat AMQ Streams Operator Installation">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-12.png" alt="Red Hat AMQ Streams Operator Installation">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At this stage, you should have Red Hat AMQ Streams operator installed on your OpenShift 4 environment
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_zookeeper_and_kafka_clusters"><a class="anchor" href="#_creating_zookeeper_and_kafka_clusters"></a>4. Creating Zookeeper and Kafka Clusters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Red Hat AMQ Streams provides the necessary operators which are responsible for deploying and managing Apache Kafka clusters on OpenShift.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure the default storage class is set to <code>ocs-storagecluster-ceph-rbd</code> Refer to <a href="https://github.com/red-hat-storage/ocs-training/tree/master/ocp4ocs4#change-the-default-storage-class-to-ceph-rbd">change the default storage class to Ceph RBD</a> module for more information.</p>
</li>
</ul>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc get sc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>$ oc get sc
NAME                                    PROVISIONER                             AGE
gp2                                     kubernetes.io/aws-ebs                   11d
ocs-storagecluster-ceph-rbd (default)   openshift-storage.rbd.csi.ceph.com      10d
ocs-storagecluster-cephfs               openshift-storage.cephfs.csi.ceph.com   10d
$</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a Kafka cluster which will also deploy a zookeeper cluster required by Kafka</p>
</li>
</ul>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc project amq-streams
oc apply -f https://raw.githubusercontent.com/red-hat-storage/ocs-training/master/ocs4kafka/01-kafka-zookeeper.yaml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Monitor the cluster progress</p>
</li>
</ul>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>watch oc get all</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finally once the Kafka cluster is up and running, you should see output similar to below</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>$ oc get all
NAME                                                      READY   STATUS    RESTARTS   AGE
pod/amq-streams-cluster-operator-v1.3.0-b94f877f5-tzhhg   1/1     Running   0          6m24s
pod/kafka-cluster-entity-operator-67668f5954-zwxzc        3/3     Running   0          31s
pod/kafka-cluster-kafka-0                                 2/2     Running   0          2m58s
pod/kafka-cluster-kafka-1                                 2/2     Running   0          2m58s
pod/kafka-cluster-kafka-2                                 2/2     Running   0          2m58s
pod/kafka-cluster-zookeeper-0                             2/2     Running   0          4m2s
pod/kafka-cluster-zookeeper-1                             2/2     Running   0          4m2s
pod/kafka-cluster-zookeeper-2                             2/2     Running   0          4m2s

NAME                                             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/kafka-cluster-kafka-0                    ClusterIP   172.30.114.98    &lt;none&gt;        9094/TCP                     3m
service/kafka-cluster-kafka-1                    ClusterIP   172.30.123.161   &lt;none&gt;        9094/TCP                     3m
service/kafka-cluster-kafka-2                    ClusterIP   172.30.99.23     &lt;none&gt;        9094/TCP                     3m
service/kafka-cluster-kafka-bootstrap            ClusterIP   172.30.228.1     &lt;none&gt;        9091/TCP,9092/TCP,9093/TCP   3m
service/kafka-cluster-kafka-brokers              ClusterIP   None             &lt;none&gt;        9091/TCP,9092/TCP,9093/TCP   3m
service/kafka-cluster-kafka-external-bootstrap   ClusterIP   172.30.121.94    &lt;none&gt;        9094/TCP                     3m
service/kafka-cluster-zookeeper-client           ClusterIP   172.30.44.252    &lt;none&gt;        2181/TCP                     4m3s
service/kafka-cluster-zookeeper-nodes            ClusterIP   None             &lt;none&gt;        2181/TCP,2888/TCP,3888/TCP   4m3s

NAME                                                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/amq-streams-cluster-operator-v1.3.0   1/1     1            1           6m25s
deployment.apps/kafka-cluster-entity-operator         1/1     1            1           32s

NAME                                                            DESIRED   CURRENT   READY   AGE
replicaset.apps/amq-streams-cluster-operator-v1.3.0-b94f877f5   1         1         1       6m25s
replicaset.apps/kafka-cluster-entity-operator-67668f5954        1         1         1       32s

NAME                                       READY   AGE
statefulset.apps/kafka-cluster-kafka       3/3     2m59s
statefulset.apps/kafka-cluster-zookeeper   3/3     4m3s

NAME                                                     HOST/PORT                                                                                          PATH   SERVICES                                 PORT   TERMINATION   WILDCARD
route.route.openshift.io/kafka-cluster-kafka-0           kafka-cluster-kafka-0-amq-streams.apps.cluster-espoo-ebad.espoo-ebad.example.opentlc.com                  kafka-cluster-kafka-0                    9094   passthrough   None
route.route.openshift.io/kafka-cluster-kafka-1           kafka-cluster-kafka-1-amq-streams.apps.cluster-espoo-ebad.espoo-ebad.example.opentlc.com                  kafka-cluster-kafka-1                    9094   passthrough   None
route.route.openshift.io/kafka-cluster-kafka-2           kafka-cluster-kafka-2-amq-streams.apps.cluster-espoo-ebad.espoo-ebad.example.opentlc.com                  kafka-cluster-kafka-2                    9094   passthrough   None
route.route.openshift.io/kafka-cluster-kafka-bootstrap   kafka-cluster-kafka-bootstrap-amq-streams.apps.cluster-espoo-ebad.espoo-ebad.example.opentlc.com          kafka-cluster-kafka-external-bootstrap   9094   passthrough   None
$</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>As a part of the Kafka/Zookeepeer cluster creation PV and PVC were created. Verify the status of PVC is <code>Bound</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc get pvc -n amq-streams
oc get pv -o json | jq -r '.items | sort_by(.spec.capacity.storage)[]| select(.spec.claimRef.namespace=="amq-streams") | [.spec.claimRef.name,.spec.capacity.storage] | @tsv'</pre>
</div>
</div>
<div class="paragraph">
<p>Example output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>$ oc get pvc -n amq-streams
NAME                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS                  AGE
data-kafka-cluster-kafka-0       Bound    pvc-91601dfe-f1b4-11e9-b1e6-0a6f9f40dc3e   100Gi      RWO            ocs-storagecluster-ceph-rbd   18h
data-kafka-cluster-kafka-1       Bound    pvc-9160e85a-f1b4-11e9-843c-12e73ceaa62c   100Gi      RWO            ocs-storagecluster-ceph-rbd   18h
data-kafka-cluster-kafka-2       Bound    pvc-91613a33-f1b4-11e9-843c-12e73ceaa62c   100Gi      RWO            ocs-storagecluster-ceph-rbd   18h
data-kafka-cluster-zookeeper-0   Bound    pvc-73630d23-f1b4-11e9-843c-12e73ceaa62c   10Gi       RWO            ocs-storagecluster-ceph-rbd   18h
data-kafka-cluster-zookeeper-1   Bound    pvc-7374c25c-f1b4-11e9-843c-12e73ceaa62c   10Gi       RWO            ocs-storagecluster-ceph-rbd   18h
data-kafka-cluster-zookeeper-2   Bound    pvc-73736821-f1b4-11e9-b1e6-0a6f9f40dc3e   10Gi       RWO            ocs-storagecluster-ceph-rbd   18h
$


$ oc get pv -o json | jq -r '.items | sort_by(.spec.capacity.storage)[]| select(.spec.claimRef.namespace=="amq-streams") | [.spec.claimRef.name,.spec.capacity.storage] | @tsv'
data-kafka-cluster-kafka-0	100Gi
data-kafka-cluster-kafka-1	100Gi
data-kafka-cluster-kafka-2	100Gi
data-kafka-cluster-zookeeper-0	10Gi
data-kafka-cluster-zookeeper-2	10Gi
data-kafka-cluster-zookeeper-1	10Gi
$</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point you have a running Kafka and Zookeeper cluster on OpenShift 4, deployed through Red Hat AMQ Streams Operator, consuming persistent block storage from OpenShift Container Storage 4</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_kafka_topic_and_kafka_user"><a class="anchor" href="#_create_kafka_topic_and_kafka_user"></a>5. Create Kafka Topic and Kafka User</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>To start consuming Kafka, we first need to create a Kafka topic. AMQ Streams provides an operator to manage Kafka Topics and Kafka Users</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc apply -f https://raw.githubusercontent.com/red-hat-storage/ocs-training/master/ocs4kafka/02-kafka-topic.yaml</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Kafka Topics (kt)</p>
</li>
</ul>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc get kt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>$ oc get kt
NAME       PARTITIONS   REPLICATION FACTOR
my-topic   3            3
$</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a Kafka user</p>
</li>
</ul>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc apply -f https://raw.githubusercontent.com/red-hat-storage/ocs-training/master/ocs4kafka/03-kafka-user.yaml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>List Kafka Users</p>
</li>
</ul>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc get kafkauser</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>$ oc get kafkauser
NAME          AUTHENTICATION   AUTHORIZATION
kafka-user1   tls              simple
$</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, we have a Kafka Topic and a Kafka user created on our Kafka Cluster using Red Hat AMQ Streams Operator</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_sample_kafka_producer_and_consumer_application"><a class="anchor" href="#_create_a_sample_kafka_producer_and_consumer_application"></a>6. Create a sample Kafka Producer and Consumer Application</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>To demonstrate Kafka usage, let&#8217;s deploy a sample hello-world-producer application</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc apply -f https://raw.githubusercontent.com/red-hat-storage/ocs-training/master/ocs4kafka/04-hello-world-producer.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>This sample application will produce 1 Million messages in an iterative manner</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To review the Kafka producer messages lets tail to the logs of <code>hello-world-producer</code> app</p>
</li>
</ul>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc logs -n amq-streams -f $(oc get pods -l app=hello-world-producer -o name)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can leave the  hello-world-consumer shell tab open to see live messages production, however, you can always press <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> to cancel the producer messages</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instead of CLI, you could also view logs from GUI</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-01.png" alt="Producer app logs">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/imgs/image-02.png" alt="Producer app logs">
</div>
</div>
<div class="paragraph">
<p>We now have a Kafka producer app generating messages and pushing the messages to Kafka Topic. We now deploy a sample hello world consumer app, which will consume messages from the Kafka Topic</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploy Kafka consumer application</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc apply -f https://raw.githubusercontent.com/red-hat-storage/ocs-training/master/ocs4kafka/05-hello-world-consumer.yaml</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Monitor logs of kafka consumer app, in real time using CLI Or via GIU (shown above)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc logs -n amq-streams -f $(oc get pods -l app=hello-world-consumer -o name)</pre>
</div>
</div>
<div class="paragraph">
<p>press <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> to cancel</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ocs_making_kafka_cluster_more_resilient"><a class="anchor" href="#_ocs_making_kafka_cluster_more_resilient"></a>7. OCS : Making Kafka cluster more resilient</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kafka out-of-the-box provides high availability and fault tolerance. However, the storage backend used underneath Kafka plays a vital role in the overall resiliency of the system.</p>
</div>
<div class="paragraph">
<p>In this section, we will demonstrate how OpenShift Container Storage increases the resiliency of the Kafka cluster by instantly attaching the PV to replacement pods in case of failure detection.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open four SSH sessions, and log in to OpenShift cluster using OC client</p>
</li>
<li>
<p>In session-1: tail the real-time logs of Kafka producer application, created in the last section</p>
</li>
</ul>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code>oc logs -n amq-streams -f $(oc get pods -l app=hello-world-producer -o name)</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In session-2 : tail the real-time logs of kafka consumer application, created in the last section</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc logs -n amq-streams -f $(oc get pods -l app=hello-world-consumer -o name)</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In session-3: watch OCP Kafka pods, PV and PVC status</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc project amq-streams
watch oc get pods,pv,pvc</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Next, we will intentionally induce Kafka pod failure. Keep a close eye on all three sessions. OCS makes Kafka pod recovery instant, resulting in no outage in your messaging infrastructure.</p>
</li>
<li>
<p>In session-4: run the following command to induce failure of the Kafka pod</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>oc delete pods kafka-cluster-kafka-0 --grace-period=0</pre>
</div>
</div>
<div class="paragraph">
<p>Summary: You will notice that the Kafka producer and consumer applications would not notice any outage due to one of the Kafka pod failure, instead they will continue to function as nothing happened. In the background, when Kubernetes detect Kafka pod failure, it immediately launches a new Kafka pod and instantly attaches the persistent volume which was once attached to the previous Kafka pod. Kafka pod upon instantiation will start serving requests without rebuilding the dataset as the data is already persisted by the OCS persistent volume.
Hence compared to ephemeral storage, OCS persistent volume, preserves the data and complement Kafka cluster with faster recovery and resiliency in case of failures.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
